<div id="progress-wrapper" class="border border-gray-200 rounded p-4 bg-white">
    <div id="pipeline-status-banner" class="flex items-center gap-2 mb-4 py-2 px-3 bg-green-50 border border-green-200 rounded text-green-800">
        <svg class="animate-spin h-5 w-5 text-green-600 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="font-medium">Pipeline running...</span>
    </div>
    <p class="font-medium mb-2">Pipeline progress</p>
    <ul id="progress-steps" class="space-y-1.5 text-sm">
        <li id="step-1" class="flex items-center gap-2 text-gray-500"><span class="step-dot w-2 h-2 rounded-full bg-gray-300 animate-pulse"></span>Step 1: JD parse — waiting...</li>
        <li id="step-2" class="flex items-center gap-2 text-gray-500"><span class="step-dot w-2 h-2 rounded-full bg-gray-300 animate-pulse"></span>Step 2: Profile map — waiting...</li>
        <li id="step-3" class="flex items-center gap-2 text-gray-500"><span class="step-dot w-2 h-2 rounded-full bg-gray-300 animate-pulse"></span>Step 3: Reframe — waiting...</li>
        <li id="step-4" class="flex items-center gap-2 text-gray-500"><span class="step-dot w-2 h-2 rounded-full bg-gray-300 animate-pulse"></span>Step 4: Keywords — waiting...</li>
        <li id="step-5" class="flex items-center gap-2 text-gray-500"><span class="step-dot w-2 h-2 rounded-full bg-gray-300 animate-pulse"></span>Step 5: Format — waiting...</li>
        <li id="step-6" class="flex items-center gap-2 text-gray-500"><span class="step-dot w-2 h-2 rounded-full bg-gray-300 animate-pulse"></span>Step 6: Scoring — waiting...</li>
        <li id="step-7" class="flex items-center gap-2 text-gray-500"><span class="step-dot w-2 h-2 rounded-full bg-gray-300 animate-pulse"></span>Step 7: PDF — waiting...</li>
    </ul>
    <div id="result-container" class="mt-4 hidden">
        <!-- Result partial will be loaded here via HTMX when complete -->
    </div>
</div>
<script>
(function() {
    const jobId = "{{ job_id }}";
    const evtSource = new EventSource("/generate/stream/" + jobId);
    const stepEls = {};
    for (let i = 1; i <= 7; i++) stepEls[i] = document.getElementById("step-" + i);

    evtSource.onmessage = function(e) {
        const d = JSON.parse(e.data);
        const step = d.step;
        const msg = d.message || "";
        const data = d.data || {};
        if (typeof step === "number" && stepEls[step]) {
            var dot = stepEls[step].querySelector(".step-dot");
            var suffix = (data.p0_count !== undefined ? " (P0: " + data.p0_count + ")" : "") + " — done";
            stepEls[step].innerHTML = '<span class="text-green-600">✓</span> Step ' + step + ": " + msg + suffix;
            stepEls[step].classList.remove("text-gray-500");
            stepEls[step].classList.add("text-green-600");
        }
        if (step === "complete") {
            evtSource.close();
            var banner = document.getElementById("pipeline-status-banner");
            if (banner) {
                banner.className = "flex items-center gap-2 mb-4 py-2 px-3 bg-green-100 border border-green-300 rounded text-green-800";
                banner.innerHTML = '<span class="text-green-600">✓</span><span class="font-medium">Pipeline complete</span>';
            }
            const container = document.getElementById("result-container");
            container.classList.remove("hidden");
            container.innerHTML = "<p class='text-gray-500'>Loading result...</p>";
            htmx.ajax("GET", "/generate/result/" + jobId, { target: "#result-container", swap: "innerHTML" });
        }
        if (step === "error") {
            evtSource.close();
            var banner = document.getElementById("pipeline-status-banner");
            if (banner) {
                banner.className = "flex items-center gap-2 mb-4 py-2 px-3 bg-red-50 border border-red-200 rounded text-red-800";
                banner.innerHTML = '<span class="text-red-600">✗</span><span class="font-medium">Pipeline failed</span>';
            }
            document.getElementById("result-container").classList.remove("hidden");
            document.getElementById("result-container").innerHTML = "<p class='text-red-600'>" + (msg || "Pipeline failed.") + "</p>";
        }
    };
    evtSource.onerror = function() {
        evtSource.close();
    };
})();
</script>
